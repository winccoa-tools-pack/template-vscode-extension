name: Build and Push WinCC OA Image

on:
  workflow_dispatch:
    inputs:
      node_version:
        description: 'Node major version to install (default 20)'
        required: false
        default: '20'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NODE_MAJOR: ${{ github.event.inputs.node_version || '20' }}
      WINCCOA_VERSION: 3.19.9
      REPO_NAME: template-vscode-extension
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      

      - name: Build image and load locally
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/Dockerfile.winccoa-node
          push: false
          load: true
          build-args: |
            NODE_MAJOR=${{ env.NODE_MAJOR }}
            REPO_NAME=${{ env.REPO_NAME }}
            WINCCOA_VERSION=${{ env.WINCCOA_VERSION }}
          tags: |
            ${{ secrets.DOCKER_USER }}/template-vscode-extension:winccoa-${{ env.WINCCOA_VERSION }}-node${{ env.NODE_MAJOR }}-template-vscode-extension
            ${{ secrets.DOCKER_USER }}/template-vscode-extension:template-vscode-extension
          labels: |
            repository=${{ env.REPO_NAME }}
            winccoa=${{ env.WINCCOA_VERSION }}
            node=${{ env.NODE_MAJOR }}

      - name: Run integration tests inside built image
        env:
          IMAGE_TAG: ${{ secrets.DOCKER_USER }}/template-vscode-extension:winccoa-${{ env.WINCCOA_VERSION }}-node${{ env.NODE_MAJOR }}-template-vscode-extension
        run: |
          set -e
          echo "Starting container from image $IMAGE_TAG"
          docker run -d --name winccoa-image-test -v "$GITHUB_WORKSPACE":/workspace -e CI=true -w /workspace $IMAGE_TAG tail -f /dev/null
          # Give the container a few seconds to start
          sleep 3
          echo "Running tests inside container..."
          docker exec --user root winccoa-image-test sh -c "xvfb-run -s '-screen 0 1280x1024x24' sh -c 'npm ci && npm test'" || {
            echo "== Container logs ==";
            docker logs winccoa-image-test || true;
            docker rm -f winccoa-image-test || true;
            exit 1;
          }
          echo "Tests passed in container"
          docker rm -f winccoa-image-test || true

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push image to Docker Hub
        run: |
          IMAGE_TAG=${{ secrets.DOCKER_USER }}/template-vscode-extension:winccoa-${{ env.WINCCOA_VERSION }}-node${{ env.NODE_MAJOR }}-template-vscode-extension
          docker push "$IMAGE_TAG"
          docker tag "$IMAGE_TAG" "${{ secrets.DOCKER_USER }}/template-vscode-extension:template-vscode-extension"
          docker push "${{ secrets.DOCKER_USER }}/template-vscode-extension:template-vscode-extension"
