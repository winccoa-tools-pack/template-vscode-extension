name: Integration Tests - WinCC OA

on:
  workflow_dispatch: {}
  push:
    branches:
      - main
      - develop

permissions:
  contents: read

jobs:
  integration:
    runs-on: ubuntu-latest
    env:
      IMAGE: mpokornyetm/winccoa:v3.19.9-full
      WORKDIR: /workspace

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin

      - name: Pull WinCC OA image
        run: docker pull $IMAGE

      - name: Run WinCC OA container
        run: |
          docker run -d --name winccoa-ci \
            -v "$GITHUB_WORKSPACE":$WORKDIR:rw \
            -e CI=true \
            -w $WORKDIR \
            $IMAGE tail -f /dev/null

      - name: Wait for WinCC OA readiness
        run: |
          set -e
          echo "Waiting for WinCC OA inside container..."
          for i in {1..60}; do
            docker exec winccoa-ci sh -c "[ -x /opt/WinCC_OA/bin/winccoa ] || true"
            if [ $? -eq 0 ]; then
              echo "Container responsive (attempt $i)";
              break;
            fi
            sleep 2
          done

      - name: Run integration tests inside container
        run: |
          # Ensure Node.js and npm are available inside the container. Try NodeSource for Node 20.x,
          # otherwise fall back to distro package managers.
          docker exec --user root winccoa-ci sh -c '
            set -e
            if command -v node >/dev/null 2>&1; then
              echo "node already installed: $(node --version)";
            else
              echo "Installing Node.js inside container...";
              if command -v apt-get >/dev/null 2>&1; then
                apt-get update && apt-get install -y curl ca-certificates gnupg && \
                curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt-get install -y nodejs;
              elif command -v yum >/dev/null 2>&1; then
                yum install -y curl && \
                curl -fsSL https://rpm.nodesource.com/setup_20.x | bash - && yum install -y nodejs;
              elif command -v apk >/dev/null 2>&1; then
                apk add --no-cache nodejs npm;
              else
                echo "No supported package manager found to install Node.js inside container.";
                exit 1;
              fi
            fi
            npm ci && npm run ci:integration
          '

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "==== docker logs ===="
          docker logs winccoa-ci || true

      - name: Stop and remove container
        if: always()
        run: |
          docker rm -f winccoa-ci || true
